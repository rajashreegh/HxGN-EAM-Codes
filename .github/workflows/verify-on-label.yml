name: Verify SQL via Label

on:
  pull_request:
    types: [labeled]

jobs:
  verify-sql:
    if: github.event.label.name == 'Verified'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0   # Fetch full history so base branch exists

      - name: Find SQL files changed in PR
        id: files
        run: |
          # Store changed SQL files between PR base and head
          CHANGED_SQL=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD -- '*.sql')
          echo "sql_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_SQL" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Mark SQL files as VERIFIED
        run: |
          while IFS= read -r file; do
            echo "Updating status in: $file"
            if grep -q -- "-- STATUS:" "$file"; then
              sed -i 's/-- STATUS:.*/-- STATUS: VERIFIED/' "$file"
            else
              sed -i '1i -- STATUS: VERIFIED' "$file"
            fi
          done <<< "${{ steps.files.outputs.sql_files }}"

      - name: Commit verification
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Verified SQL files automatically based on label" || echo "No changes to commit"
          git push
