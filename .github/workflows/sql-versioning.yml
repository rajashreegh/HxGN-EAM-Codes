name: Auto Version SQL Files

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto_version:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # fetch full history so versioning works

      # -------------------------
      - name: Identify modified SQL files
        id: files
        run: |
          # Get SQL files changed in PR
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }} | grep -E '\.sql$' || true)
          echo "changed_sql=$CHANGED" >> $GITHUB_OUTPUT
          echo "Changed SQL files:"
          echo "$CHANGED"

      # -------------------------
      - name: Stop if no SQL files
        if: steps.files.outputs.changed_sql == ''
        run: echo "No SQL files changed. Skipping versioning."

      # -------------------------
      - name: Process versioning
        if: steps.files.outputs.changed_sql != ''
        run: |
          echo "${{ steps.files.outputs.changed_sql }}" | while IFS= read -r FILE; do
            # Skip empty lines
            [[ -z "$FILE" ]] && continue

            echo "Processing '$FILE'"

            # Extract the current version in the file (e.g. -- Version: 3)
            CUR_VER=$(grep -oEi 'version[: ]+[0-9]+' "$FILE" | grep -o '[0-9]*' | head -1)
            [[ -z "$CUR_VER" ]] && CUR_VER=0

            # Find latest version from Git history
            LAST_VER=$(git log --pretty=format:"%s" -- "$FILE" | grep -oEi 'version[: ]+[0-9]+' | grep -o '[0-9]*' | sort -nr | head -1)
            [[ -z "$LAST_VER" ]] && LAST_VER=0

            # Determine next version
            NEXT_VER=$(( LAST_VER + 1 ))

            echo "Detected Version in File: $CUR_VER"
            echo "Latest Git Version: $LAST_VER"
            echo "Using NEXT Version: $NEXT_VER"

            # Remove old version line if exists
            sed -i '/[Vv]ersion[: ]*[0-9]\+/d' "$FILE"

            # Insert new version at the top of the file
            sed -i "1i -- Version: $NEXT_VER" "$FILE"

            echo "Updated version inserted."
          done

      # -------------------------
      - name: Commit & push version updates
        if: steps.files.outputs.changed_sql != ''
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Stage only changed SQL files
          echo "${{ steps.files.outputs.changed_sql }}" | while IFS= read -r FILE; do
            [[ -z "$FILE" ]] && continue
            git add "$FILE"
          done

          # Commit only if there are staged changes
          if git diff --cached --quiet; then
            echo "No version changes to commit."
          else
            git commit -m "Auto-version SQL files (Version updated)"
            git push
          fi
