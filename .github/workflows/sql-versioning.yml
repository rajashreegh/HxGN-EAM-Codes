name: Auto Version SQL Files

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto_version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # needed to read previous versions

      - name: Identify modified SQL files
        id: files
        run: |
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }} | grep -E '\.sql$' || true)
          echo "changed_sql=$CHANGED" >> $GITHUB_OUTPUT
          echo "SQL files: $CHANGED"

      - name: Stop if no SQL files
        if: steps.files.outputs.changed_sql == ''
        run: echo "No SQL files changed. Skipping versioning."

      - name: Process versioning
        if: steps.files.outputs.changed_sql != ''
        run: |
          for FILE in ${{ steps.files.outputs.changed_sql }}; do
            echo "Processing $FILE"

            # Extract the current version from the file (e.g. -- Version: 3)
            CUR_VER=$(grep -oEi 'version[: ]+[0-9]+' "$FILE" | grep -o '[0-9]*' | head -1)

            if [[ -z "$CUR_VER" ]]; then
              CUR_VER=0
            fi

            # Find latest version from Git history (reliable)
            LAST_VER=$(git log --pretty=format:"%s" -- "$FILE" | grep -oEi 'version[: ]+[0-9]+' | grep -o '[0-9]*' | sort -nr | head -1)

            if [[ -z "$LAST_VER" ]]; then
              LAST_VER=0
            fi

            # Determine next version
            NEXT_VER=$(( LAST_VER + 1 ))

            echo "Detected Version in File: $CUR_VER"
            echo "Latest Git Version: $LAST_VER"
            echo "Using NEXT Version: $NEXT_VER"

            # Remove old version line if exists
            sed -i '/[Vv]ersion[: ]*[0-9]\+/d' "$FILE"

            # Insert new version at the top of the file
            sed -i "1i -- Version: $NEXT_VER" "$FILE"

            echo "Updated version inserted."
          done

      - name: Commit & push version updates
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git diff --quiet; then
            echo "No version changes to commit."
          else
            git add .
            git commit -m "Auto-version SQL files (Version updated)"
            git push
          fi
