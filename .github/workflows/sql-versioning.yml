name: SQL Auto Versioning

on:
  push:
    branches: [main]

jobs:
  version-sql:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Add version to SQL files
        run: |
          echo "Processing SQL files..."

          # Process ONLY these two folders
          for folder in "Flex Business Rules" "Extensible Frameworks"; do
            echo "Checking folder: $folder"

            # Find SQL files safely
            find "$folder" -type f -name "*.sql" | while read -r file; do
              echo "Processing $file"

              # Try to read version line
              VERSION_LINE=$(grep -i "^-- Version:" "$file" || true)

              if [ -z "$VERSION_LINE" ]; then
                echo "No version found → adding Version: 1"
                sed -i "1s|^|-- Version: 1\n|" "$file"
              else
                CURRENT=$(echo "$VERSION_LINE" | awk '{print $3}')
                NEW=$((CURRENT + 1))
                echo "Updating version $CURRENT → $NEW"
                sed -i "s/^-- Version: .*/-- Version: $NEW/" "$file"
              fi
            done
          done

      - name: Commit version update to main
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add .
          git commit -m "Auto-update SQL version after merge" || echo "No changes to commit"
          git push origin main

      - name: Sync dev with updated SQL versions
        run: |
          git fetch origin
          git checkout dev
          git merge origin/main --no-edit
          git push origin dev
